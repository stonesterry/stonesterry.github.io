{"meta":{"title":"stonesterry","subtitle":"linux/filesystem","description":"filesystem","author":"stonesterry","url":"http://stonesterry.cn","root":"/"},"pages":[{"title":"c_container_of","date":"2020-04-29T14:21:23.000Z","updated":"2020-04-29T14:21:23.953Z","comments":true,"path":"c-container-of/index.html","permalink":"http://stonesterry.cn/c-container-of/index.html","excerpt":"","text":""}],"posts":[{"title":"container_of","slug":"c-container-of","date":"2020-04-29T13:04:27.000Z","updated":"2020-04-29T14:55:52.674Z","comments":true,"path":"2020/04/29/c-container-of/","link":"","permalink":"http://stonesterry.cn/2020/04/29/c-container-of/","excerpt":"","text":"作用通过结构体变量的某个成员的地址来获取整个结构体的首地址 解析以linux4.19的container_of为例 123456789101112131415/** * container_of - cast a member of a structure out to the containing structure * @ptr: the pointer to the member. * @type: the type of the container struct this is embedded in. * @member: the name of the member within the struct. * */#define container_of(ptr, type, member) (&#123; \\ void *__mptr = (void *)(ptr); \\ BUILD_BUG_ON_MSG(!__same_type(*(ptr), ((type *)0)-&gt;member) &amp;&amp; \\ !__same_type(*(ptr), void), \\ \"pointer type mismatch in container_of()\"); \\ ((type *)(__mptr - offsetof(type, member))); &#125;)#define offsetof(TYPE, MEMBER) ((size_t)&amp;((TYPE *)0)-&gt;MEMBER) ptr:指向结构体member成员的指针type:member成员所在结构体的数据类型member:结构体成员为member的变量 首先定义了一个(void *)的指针__mptr，指向ptr BUILD_BUG_ON_MSG的作用是做防御性的判断，判断类型是否一致，若不一致则会报错 ((type *)(__mptr - offsetof(type, member)))这是整个container_of的核心,即得到结构体的首地址，对offsetof(type, member)进行展开123456#define offsetof(TYPE, MEMBER) ((size_t)&amp;((TYPE *)0)-&gt;MEMBER)&amp;((TYPE *)0)-&gt;MEMBER:将0地址转换为TYPE型的，然后取出其MEMBER成员的地址。换句话说得到MEMBER成员相对于结构体首地址的相对偏移量，再用__mptr减去这个相对偏移地址即得到结构体的首地址了。需要说明一点的是__mptr变量的结构类型为(void *)是有特殊含义的,我们知道指针变量进行加减运算时，实际上加减n*sizeof(指针类型)。如int *p;p++实际上等于p+sizeof(int) 测试 源码1234567891011121314151617181920212223242526#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;typedef struct test_container_of&#123; char a; int b; double c;&#125;tag_test_container_of;int main()&#123; tag_test_container_of test_var; printf(\"test_var addr= 0x%p\\n\", &amp;test_var); printf(\"test_var.c addr=0x%p\\n\", &amp;test_var.c); printf(\"offset c in tag_test_container_of is %d\\n\", (long long)(&amp;(((tag_test_container_of*)0)-&gt;c))); printf(\"addr test_var.c - offset c in tag_test_container_of = 0x%x\\n\", (&amp;test_var.c) - (int)(&amp;(((tag_test_container_of*)0)-&gt;c))); printf(\"addr test_var.c - offset c in tag_test_container_of = 0x%x\\n\", (void *)(&amp;test_var.c) - (char)(&amp;(((tag_test_container_of*)0)-&gt;c))); return 0;&#125; 结果12345678test_var addr= 0x000000000062FE10test_var.c addr=0x000000000062FE18offset c in tag_test_container_of is 8addr test_var.c - offset c in tag_test_container_of(type=int) = 0x62fdd8 (0x000000000062FE18-8*sizeof(int))addr test_var.c - offset c in tag_test_container_of(type=char) = 0x62fe10 (0x000000000062FE18-8*sizeof(char))/* 0x62fdd8 = (0x000000000062FE18-8*sizeof(int)) *//* 0x62fe10 = (0x000000000062FE18-8*sizeof(char)) */","categories":[],"tags":[{"name":"c基础知识","slug":"c基础知识","permalink":"http://stonesterry.cn/tags/c%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"}]}],"categories":[],"tags":[{"name":"c基础知识","slug":"c基础知识","permalink":"http://stonesterry.cn/tags/c%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"}]}